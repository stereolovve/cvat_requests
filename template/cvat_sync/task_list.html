{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load cvat_extras %}

{% block title %}Tasks CVAT - CVAT Sync{% endblock %}
{% block page_title %}Tasks Sincronizadas do CVAT{% endblock %}

{% block content %}
<div class="space-y-3">

    <!-- =========================== HEADER BAR =========================== -->
    <div class="flex items-center justify-between gap-3">
        <!-- View Mode Toggle -->
        <div class="inline-flex rounded-lg bg-slate-800/50 border border-slate-700/50 p-1 gap-1">
            <a href="?view=list{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}"
               class="px-4 py-2 rounded text-xs font-medium transition-all {% if view_mode == 'list' %}bg-blue-600 text-white{% else %}text-slate-400 hover:text-white hover:bg-slate-700/50{% endif %}">
                <i class="fas fa-list mr-1"></i>Lista
            </a>
            <a href="?view=grouped{% if search %}&search={{ search }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}"
               class="px-4 py-2 rounded text-xs font-medium transition-all {% if view_mode == 'grouped' %}bg-blue-600 text-white{% else %}text-slate-400 hover:text-white hover:bg-slate-700/50{% endif %}">
                <i class="fas fa-columns mr-1"></i>Agrupado
            </a>
            <a href="?view=dashboard"
               class="px-4 py-2 rounded text-xs font-medium transition-all {% if view_mode == 'dashboard' %}bg-blue-600 text-white{% else %}text-slate-400 hover:text-white hover:bg-slate-700/50{% endif %}">
                <i class="fas fa-chart-bar mr-1"></i>Dashboard
            </a>
        </div>

        <!-- Quick Stats (Compact) -->
        <div class="flex items-center gap-3 text-xs">
            <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-800/50 rounded">
                <i class="fas fa-tasks text-blue-400"></i>
                <span class="text-slate-400">Total:</span>
                <span class="text-white font-semibold">{{ stats.total_tasks }}</span>
            </div>
            <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-800/50 rounded">
                <i class="fas fa-clock text-orange-400"></i>
                <span class="text-slate-400">Andamento:</span>
                <span class="text-white font-semibold">{{ tasks_em_andamento }}</span>
            </div>
            <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-800/50 rounded">
                <i class="fas fa-check-circle text-green-400"></i>
                <span class="text-slate-400">Concluídas:</span>
                <span class="text-white font-semibold">{{ tasks_concluidas }}</span>
            </div>
        </div>

        <!-- Sync Button -->
        <form method="post" action="{% url 'cvat_sync' %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="inline-flex items-center gap-1.5 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-lg transition-colors">
                <i class="fas fa-sync-alt text-xs"></i>
                Sincronizar
            </button>
        </form>
    </div>

    <!-- =========================== FILTERS (Inline, Always Visible) =========================== -->
    {% if view_mode != 'dashboard' %}
    <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg p-3">
        <form method="get" class="flex flex-wrap gap-2 items-end">
            <input type="hidden" name="view" value="{{ view_mode }}">

            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-slate-400 text-xs font-medium mb-1">
                    <i class="fas fa-search mr-1"></i>Buscar
                </label>
                <input type="text"
                       name="search"
                       value="{{ search }}"
                       placeholder="Nome da task..."
                       class="w-full bg-slate-800/50 border border-slate-700 text-white text-xs rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 outline-none transition-all">
            </div>

            <!-- Project -->
            <div class="min-w-[150px]">
                <label class="block text-slate-400 text-xs font-medium mb-1">
                    <i class="fas fa-project-diagram mr-1"></i>Projeto
                </label>
                <select name="project" class="w-full bg-slate-800/50 border border-slate-700 text-white text-xs rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 outline-none transition-all">
                    <option value="">Todos</option>
                    {% for project in projects %}
                        {% if project %}
                            <option value="{{ project }}" {% if project_filter == project %}selected{% endif %}>
                                {{ project|truncatechars:30 }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Assignee -->
            <div class="min-w-[150px]">
                <label class="block text-slate-400 text-xs font-medium mb-1">
                    <i class="fas fa-user mr-1"></i>Responsável
                </label>
                <select name="assignee" class="w-full bg-slate-800/50 border border-slate-700 text-white text-xs rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 outline-none transition-all">
                    <option value="">Todos</option>
                    {% for assignee in assignees %}
                        {% if assignee %}
                            <option value="{{ assignee }}" {% if assignee_filter == assignee %}selected{% endif %}>
                                {{ assignee }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Status (only in list view) -->
            {% if view_mode == 'list' %}
            <div class="min-w-[130px]">
                <label class="block text-slate-400 text-xs font-medium mb-1">
                    <i class="fas fa-flag mr-1"></i>Status
                </label>
                <select name="status" class="w-full bg-slate-800/50 border border-slate-700 text-white text-xs rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 outline-none transition-all">
                    <option value="">Todos</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex gap-2">
                <button type="submit" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded transition-colors">
                    <i class="fas fa-filter mr-1"></i>Filtrar
                </button>

                {% if search or status_filter or assignee_filter or project_filter %}
                <a href="?view={{ view_mode }}" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium rounded transition-colors inline-flex items-center">
                    <i class="fas fa-times mr-1"></i>Limpar
                </a>
                {% endif %}
            </div>
        </form>

        <!-- Active Filters Pills -->
        {% if search or status_filter or assignee_filter or project_filter %}
        <div class="mt-2 flex flex-wrap gap-1.5">
            <span class="text-slate-500 text-xs">Filtros ativos:</span>
            {% if search %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-900/30 text-blue-300 rounded text-xs">
                    <i class="fas fa-search"></i> "{{ search }}"
                    <button onclick="removeFilter('search')" class="ml-1 hover:text-blue-100">×</button>
                </span>
            {% endif %}
            {% if project_filter %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-purple-900/30 text-purple-300 rounded text-xs">
                    <i class="fas fa-project-diagram"></i> {{ project_filter|truncatechars:20 }}
                    <button onclick="removeFilter('project')" class="ml-1 hover:text-purple-100">×</button>
                </span>
            {% endif %}
            {% if assignee_filter %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-green-900/30 text-green-300 rounded text-xs">
                    <i class="fas fa-user"></i> {{ assignee_filter }}
                    <button onclick="removeFilter('assignee')" class="ml-1 hover:text-green-100">×</button>
                </span>
            {% endif %}
            {% if status_filter %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-orange-900/30 text-orange-300 rounded text-xs">
                    <i class="fas fa-flag"></i> {{ status_filter|get_status_display }}
                    <button onclick="removeFilter('status')" class="ml-1 hover:text-orange-100">×</button>
                </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- =========================== GROUPED VIEW =========================== -->
    {% if view_mode == 'grouped' %}
        <div class="space-y-3 grouped-view-container">
            {% if tasks_por_status %}
                {% for status_value, status_label in status_choices %}
                    {% with status_data=tasks_por_status|get_item:status_value %}
                        {% if status_data.tasks %}
                        <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg overflow-hidden" data-status="{{ status_value }}">
                            <!-- Group Header (Compact) -->
                            <div class="bg-slate-800/30 px-3 py-2 border-b border-slate-700/50 flex items-center gap-2 cursor-pointer hover:bg-slate-800/50 transition-all" onclick="toggleGroup('{{ status_value }}')">
                                <!-- Chevron -->
                                <svg class="w-3 h-3 text-slate-400 transition-all duration-200" id="chevron-{{ status_value }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
                                </svg>

                                <!-- Status Badge -->
                                <span class="inline-flex items-center px-2 py-0.5 badge-{{ status_value }} rounded text-xs font-semibold uppercase tracking-wide">
                                    <i class="fas {{ status_value|get_status_icon }} mr-1"></i>
                                    {{ status_label }}
                                </span>

                                <!-- Counter -->
                                <span class="text-slate-400 text-xs font-medium px-1.5 py-0.5 bg-slate-900/50 rounded">
                                    {{ status_data.count }}
                                </span>
                            </div>

                            <!-- Group Content (Compact Table) -->
                            <div id="group-content-{{ status_value }}" style="display: block;">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs">
                                        <thead class="bg-slate-800/20">
                                            <tr>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Task ID</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Job ID</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Nome</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Projeto</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Responsável</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">Stage</th>
                                                <th class="px-2 py-1.5 text-left text-slate-400 font-medium">State</th>
                                                <th class="px-2 py-1.5 text-center text-slate-400 font-medium">Anotações</th>
                                                <th class="px-2 py-1.5 text-center text-slate-400 font-medium">Última Sync</th>
                                                <th class="px-2 py-1.5 text-center text-slate-400 font-medium">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for task in status_data.tasks %}
                                            <tr class="border-t border-slate-800/30 hover:bg-slate-800/20 transition-colors">
                                                <td class="px-2 py-2 font-mono text-purple-400">#{{ task.cvat_task_id }}</td>
                                                <td class="px-2 py-2 font-mono text-blue-400">#{{ task.cvat_job_id }}</td>
                                                <td class="px-2 py-2">
                                                    <a href="{% url 'cvat_task_detail' task.pk %}" class="text-white hover:text-blue-400 transition-colors">
                                                        {{ task.task_name|truncatechars:35 }}
                                                    </a>
                                                </td>
                                                <td class="px-2 py-2 text-slate-300">
                                                    {{ task.project_name|truncatechars:25|default:"-" }}
                                                </td>
                                                <td class="px-2 py-2">
                                                    {% if task.assignee %}
                                                        <span class="inline-block px-1.5 py-0.5 bg-blue-900/30 text-blue-400 rounded text-xs">
                                                            {{ task.assignee }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-slate-500">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-2 py-2">
                                                    {% if task.stage %}
                                                        <span class="inline-block px-1.5 py-0.5 {% if task.stage == 'acceptance' %}bg-purple-900/30 text-purple-400{% elif task.stage == 'validation' %}bg-yellow-900/30 text-yellow-400{% elif task.stage == 'annotation' %}bg-blue-900/30 text-blue-400{% else %}bg-slate-700/30 text-slate-400{% endif %} rounded text-xs">
                                                            {{ task.stage }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-slate-500">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-2 py-2">
                                                    {% if task.cvat_state %}
                                                        <span class="inline-block px-1.5 py-0.5 {% if task.cvat_state == 'completed' %}bg-green-900/30 text-green-400{% elif task.cvat_state == 'in progress' %}bg-blue-900/30 text-blue-400{% elif task.cvat_state == 'rejected' %}bg-red-900/30 text-red-400{% else %}bg-slate-700/30 text-slate-400{% endif %} rounded text-xs">
                                                            {{ task.cvat_state }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-slate-500">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-2 py-2 text-center">
                                                    <span class="px-1.5 py-0.5 bg-green-900/30 text-green-400 rounded font-mono font-semibold">
                                                        {{ task.total_annotations|intcomma }}
                                                    </span>
                                                </td>
                                                <td class="px-2 py-2 text-center text-slate-400">
                                                    {{ task.last_synced_at|naturaltime }}
                                                </td>
                                                <td class="px-2 py-2 text-center">
                                                    <div class="flex items-center justify-center gap-1">
                                                        <a href="{% url 'cvat_task_detail' task.pk %}" class="px-1.5 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors" title="Ver detalhes">
                                                            <i class="fas fa-eye text-xs"></i>
                                                        </a>
                                                        {% if task.cvat_url %}
                                                        <a href="{{ task.cvat_url }}" target="_blank" class="px-1.5 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors" title="Abrir no CVAT">
                                                            <i class="fas fa-external-link-alt text-xs"></i>
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}

                <!-- Infinite Scroll Sentinel -->
                <div id="scroll-sentinel" class="h-1"></div>
            {% else %}
                <div class="p-8 text-center bg-slate-900/50 border border-slate-800/50 rounded-lg">
                    <i class="fas fa-inbox text-slate-600 text-4xl mb-3"></i>
                    <p class="text-slate-400">Nenhuma task encontrada</p>
                </div>
            {% endif %}
        </div>

    <!-- =========================== DASHBOARD VIEW =========================== -->
    {% elif view_mode == 'dashboard' %}
        <div class="space-y-3" id="dashboard-view">
            <!-- Date Filter (Compact) -->
            <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg p-3">
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-slate-400 text-xs font-medium">Período:</span>
                    <button onclick="loadDashboardData('7d')" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors" id="filter-7d">
                        7 dias
                    </button>
                    <button onclick="loadDashboardData('30d')" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded transition-colors" id="filter-30d">
                        30 dias
                    </button>
                    <button onclick="loadDashboardData('this_month')" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors" id="filter-this_month">
                        Este mês
                    </button>
                    <button onclick="loadDashboardData('last_month')" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors" id="filter-last_month">
                        Mês passado
                    </button>
                </div>
            </div>

            <!-- Metrics Cards (Compact) -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3">
                    <p class="text-slate-400 text-xs font-medium uppercase mb-1">Total Tasks</p>
                    <p class="text-2xl font-bold text-white" id="metric-total-tasks">-</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3">
                    <p class="text-slate-400 text-xs font-medium uppercase mb-1">Concluídas</p>
                    <p class="text-2xl font-bold text-green-400" id="metric-concluidas">-</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3">
                    <p class="text-slate-400 text-xs font-medium uppercase mb-1">Taxa Conclusão</p>
                    <p class="text-2xl font-bold text-blue-400" id="metric-taxa">-</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3">
                    <p class="text-slate-400 text-xs font-medium uppercase mb-1">Tempo Médio</p>
                    <p class="text-2xl font-bold text-purple-400" id="metric-tempo">-</p>
                </div>
                <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3">
                    <p class="text-slate-400 text-xs font-medium uppercase mb-1">Total Anotações</p>
                    <p class="text-2xl font-bold text-orange-400" id="metric-anotacoes">-</p>
                </div>
            </div>

            <!-- Charts (Compact) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg p-3">
                    <h3 class="text-white text-sm font-semibold mb-2">Ranking por Tasks</h3>
                    <canvas id="chart-tasks"></canvas>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg p-3">
                    <h3 class="text-white text-sm font-semibold mb-2">Ranking por Anotações</h3>
                    <canvas id="chart-anotacoes"></canvas>
                </div>
                <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg p-3">
                    <h3 class="text-white text-sm font-semibold mb-2">Produtividade</h3>
                    <canvas id="chart-produtividade"></canvas>
                </div>
            </div>
        </div>

    <!-- =========================== LIST VIEW (Default) =========================== -->
    {% else %}
        <div class="bg-slate-900/50 border border-slate-800/50 rounded-lg overflow-hidden">
            {% if tasks %}
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead class="bg-slate-800/50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('cvat_task_id')">
                                    Task ID
                                    {% if sort_field == 'cvat_task_id' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('cvat_job_id')">
                                    Job ID
                                    {% if sort_field == 'cvat_job_id' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('task_name')">
                                    Nome
                                    {% if sort_field == 'task_name' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('project_name')">
                                    Projeto
                                    {% if sort_field == 'project_name' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium">Responsável</th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium">Status</th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium">Stage</th>
                                <th class="px-2 py-2 text-left text-slate-400 font-medium">State</th>
                                <th class="px-2 py-2 text-center text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('total_annotations')">
                                    Anotações
                                    {% if sort_field == 'total_annotations' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-center text-slate-400 font-medium cursor-pointer hover:text-white" onclick="sortTable('last_synced_at')">
                                    Última Sync
                                    {% if sort_field == 'last_synced_at' %}
                                        <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %} text-blue-400 ml-1"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-slate-500 ml-1"></i>
                                    {% endif %}
                                </th>
                                <th class="px-2 py-2 text-center text-slate-400 font-medium">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr class="border-t border-slate-800/30 hover:bg-slate-800/20 transition-colors">
                                <td class="px-2 py-2 font-mono text-purple-400">#{{ task.cvat_task_id }}</td>
                                <td class="px-2 py-2 font-mono text-blue-400">#{{ task.cvat_job_id }}</td>
                                <td class="px-2 py-2">
                                    <a href="{% url 'cvat_task_detail' task.pk %}" class="text-white hover:text-blue-400 transition-colors">
                                        {{ task.task_name|truncatechars:35 }}
                                    </a>
                                </td>
                                <td class="px-2 py-2 text-slate-300">
                                    {{ task.project_name|truncatechars:25|default:"-" }}
                                </td>
                                <td class="px-2 py-2">
                                    {% if task.assignee %}
                                        <span class="inline-block px-1.5 py-0.5 bg-blue-900/30 text-blue-400 rounded text-xs">
                                            {{ task.assignee }}
                                        </span>
                                    {% else %}
                                        <span class="text-slate-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-2">
                                    <span class="inline-block px-1.5 py-0.5 {{ task.get_status_badge_class }} rounded text-xs">
                                        {{ task.get_status_display }}
                                    </span>
                                </td>
                                <td class="px-2 py-2">
                                    {% if task.stage %}
                                        <span class="inline-block px-1.5 py-0.5 {% if task.stage == 'acceptance' %}bg-purple-900/30 text-purple-400{% elif task.stage == 'validation' %}bg-yellow-900/30 text-yellow-400{% elif task.stage == 'annotation' %}bg-blue-900/30 text-blue-400{% else %}bg-slate-700/30 text-slate-400{% endif %} rounded text-xs">
                                            {{ task.stage }}
                                        </span>
                                    {% else %}
                                        <span class="text-slate-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-2">
                                    {% if task.cvat_state %}
                                        <span class="inline-block px-1.5 py-0.5 {% if task.cvat_state == 'completed' %}bg-green-900/30 text-green-400{% elif task.cvat_state == 'in progress' %}bg-blue-900/30 text-blue-400{% elif task.cvat_state == 'rejected' %}bg-red-900/30 text-red-400{% else %}bg-slate-700/30 text-slate-400{% endif %} rounded text-xs">
                                            {{ task.cvat_state }}
                                        </span>
                                    {% else %}
                                        <span class="text-slate-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <span class="px-1.5 py-0.5 bg-green-900/30 text-green-400 rounded font-mono font-semibold">
                                        {{ task.total_annotations|intcomma }}
                                    </span>
                                </td>
                                <td class="px-2 py-2 text-center text-slate-400">
                                    {{ task.last_synced_at|naturaltime }}
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <a href="{% url 'cvat_task_detail' task.pk %}" class="px-1.5 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors" title="Ver detalhes">
                                            <i class="fas fa-eye text-xs"></i>
                                        </a>
                                        {% if task.cvat_url %}
                                        <a href="{{ task.cvat_url }}" target="_blank" class="px-1.5 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors" title="Abrir no CVAT">
                                            <i class="fas fa-external-link-alt text-xs"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination (Compact) -->
                {% if page_obj.has_other_pages %}
                <div class="p-3 border-t border-slate-700/50">
                    <nav class="flex items-center justify-between">
                        <div class="text-xs text-slate-400">
                            {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
                        </div>
                        <div class="flex gap-1">
                            {% if page_obj.has_previous %}
                                <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&view={{ view_mode }}"
                                   class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                                <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&view={{ view_mode }}"
                                   class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            {% endif %}

                            <span class="px-3 py-1 bg-slate-800 rounded text-xs text-white">
                                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                            </span>

                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&view={{ view_mode }}"
                                   class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                                <a href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}{% if assignee_filter %}&assignee={{ assignee_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&view={{ view_mode }}"
                                   class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded transition-colors">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            {% endif %}
                        </div>
                    </nav>
                </div>
                {% endif %}

            {% else %}
                <div class="p-8 text-center">
                    <i class="fas fa-inbox text-slate-600 text-4xl mb-3"></i>
                    <p class="text-slate-400">Nenhuma task encontrada</p>
                    <p class="text-slate-500 text-xs mt-2">Execute a sincronização para importar tasks do CVAT</p>

                    <form method="post" action="{% url 'cvat_sync' %}" class="mt-4">
                        {% csrf_token %}
                        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                            <i class="fas fa-sync-alt"></i>
                            Sincronizar Agora
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Inline JavaScript -->
<script>
// CVAT Task List - JavaScript Inline
window.DASHBOARD_API_URL = "{% url 'dashboard_metrics' %}";

let chartsInstances = {};

// Dashboard functions
function loadDashboardData(quickFilter) {
    const metricIds = ['metric-total-tasks', 'metric-concluidas', 'metric-taxa', 'metric-tempo', 'metric-anotacoes'];
    metricIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin text-slate-500"></i>';
    });

    fetch(`${window.DASHBOARD_API_URL}?quick_filter=${quickFilter}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            document.getElementById('metric-total-tasks').textContent = data.metrics.total_tasks;
            document.getElementById('metric-concluidas').textContent = data.metrics.total_concluidas;
            document.getElementById('metric-taxa').textContent = `${data.metrics.taxa_conclusao}%`;
            document.getElementById('metric-tempo').textContent = `${data.metrics.tempo_medio_dias} dias`;
            document.getElementById('metric-anotacoes').textContent = data.metrics.total_anotacoes.toLocaleString('pt-BR');

            updateChart('chart-tasks', data.rankings.by_tasks, 'tasks_completed', 'Tasks Concluídas');
            updateChart('chart-anotacoes', data.rankings.by_anotacoes, 'total_anotacoes', 'Total Anotações');
            updateChart('chart-produtividade', data.rankings.by_productivity, 'productivity', 'Produtividade');

            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-700');
            });
            const activeBtn = document.getElementById('filter-' + quickFilter);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-700');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
        })
        .catch(error => {
            console.error('Error loading dashboard:', error);
            metricIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<span class="text-red-400">Erro</span>';
            });
        });
}

function updateChart(canvasId, data, valueKey, label) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    if (chartsInstances[canvasId]) {
        chartsInstances[canvasId].destroy();
    }

    const labels = data.map(item => item.assignee || item.username || 'Unknown');
    const values = data.map(item => item[valueKey]);

    chartsInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: values,
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#94a3b8', font: { size: 11 } },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                },
                x: {
                    ticks: { color: '#94a3b8', font: { size: 11 } },
                    grid: { display: false }
                }
            }
        }
    });
}

// Sorting function
function sortTable(column) {
    const url = new URL(window.location.href);
    const currentSort = url.searchParams.get('sort');
    const currentOrder = url.searchParams.get('order') || 'desc';

    let newOrder = 'asc';
    if (currentSort === column) {
        newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    }

    url.searchParams.set('sort', column);
    url.searchParams.set('order', newOrder);
    window.location.href = url.toString();
}

// Group toggle
function toggleGroup(statusValue) {
    const content = document.getElementById('group-content-' + statusValue);
    const chevron = document.getElementById('chevron-' + statusValue);

    if (!content || !chevron) return;

    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
        localStorage.setItem('cvat_group_' + statusValue, 'open');
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
        localStorage.setItem('cvat_group_' + statusValue, 'closed');
    }
}

// Filter removal
function removeFilter(filterName) {
    const url = new URL(window.location.href);
    url.searchParams.delete(filterName);
    window.location.href = url.toString();
}

// Page load
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard if in dashboard view
    if (document.getElementById('dashboard-view')) {
        loadDashboardData('30d');
    }

    // Restore group states
    document.querySelectorAll('[data-status]').forEach(group => {
        const statusValue = group.getAttribute('data-status');
        const savedState = localStorage.getItem('cvat_group_' + statusValue);
        if (savedState === 'closed') {
            toggleGroup(statusValue);
        }
    });
});
</script>
{% endblock %}
